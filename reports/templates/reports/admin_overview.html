{% extends "base.html" %}
{% load static %}

{% block title %}Admin Reports{% endblock %}

{% block content %}
<div class="container mt-3">
  <h2>Reports Overview</h2>

  <!-- ================= FILTERS + EXPORT ================= -->
  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">

    <!-- Filters -->
    <form method="get" class="d-flex gap-2 align-items-center flex-wrap">
      <label for="team">Team:</label>
      <select name="team" id="team" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
        <option value="">All Teams</option>
        {% for team in teams %}
          <option value="{{ team }}" {% if selected_team == team %}selected{% endif %}>{{ team|capfirst }}</option>
        {% endfor %}
      </select>

      <label for="user">User:</label>
      <select name="user" id="user" onchange="this.form.submit()" class="form-select form-select-sm w-auto">
        <option value="">All Users</option>
        {% for u in users %}
          <option value="{{ u.username }}" {% if selected_user == u.username %}selected{% endif %}>{{ u.username }}</option>
        {% endfor %}
      </select>

      <label for="date">Date:</label>
      <input type="date" name="date" id="date" value="{{ request.GET.date }}" onchange="this.form.submit()" class="form-control form-control-sm w-auto">
    </form>

    <!-- Export buttons -->
    <div class="d-flex align-items-center gap-2">
      <!-- Single-day Export -->
      <a href="{% url 'export_reports_excel' %}?team={{ selected_team }}&user={{ selected_user }}&date={{ request.GET.date }}"
         class="btn btn-success btn-sm">Export to Excel</a>

      <!-- Range Export -->
      <form method="post" action="{% url 'export_reports_excel' %}" class="d-flex align-items-center gap-2">
        {% csrf_token %}
        <label for="start_date" class="mb-0 small">From:</label>
        <input type="date" name="start_date" id="start_date" class="form-control form-control-sm w-auto" required>

        <label for="end_date" class="mb-0 small">To:</label>
        <input type="date" name="end_date" id="end_date" class="form-control form-control-sm w-auto" required>

        <button type="submit" class="btn btn-outline-success btn-sm">Export Range</button>
      </form>
    </div>
  </div>

  <hr>

  <!-- Reports by Team -->
  <h4>ðŸ“ˆ Reports by Team</h4>
  <table class="table table-sm table-striped">
    <thead><tr><th>Team</th><th>Total Reports</th></tr></thead>
    <tbody>
      {% for row in reports_by_team %}
        <tr>
          <td>{{ row.user__team|default:"â€”"|capfirst }}</td>
          <td>{{ row.total }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="2">No data available.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- User Comparison Section -->
  <h4 class="mt-4">ðŸ‘¥ User Comparison</h4>

  <!-- Chart Canvas -->
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <canvas id="userComparisonChart" height="120"></canvas>
    </div>
  </div>

  <!-- Reports by User Table -->
  <table class="table table-sm table-bordered">
    <thead><tr><th>User</th><th>Total Reports</th></tr></thead>
    <tbody>
      {% for row in reports_by_user %}
        <tr>
          <td>{{ row.user__username }}</td>
          <td>{{ row.total }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="2">No users found.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- All Combined Reports -->
  <h4 class="mt-4">ðŸ“‹ All Combined Reports</h4>
  <table class="table table-sm table-bordered">
    <thead class="table-dark">
      <tr>
        <th>User</th>
        <th>Team</th>
        <th>Shift</th>
        <th>Report Date</th>
        <th>Submitted At</th>
        <th>Tasks</th>
        <th>Notes</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for report in reports %}
        <tr>
          <td>
            <a href="{% url 'user_report_detail' report.user.username %}" class="text-decoration-none fw-semibold">
            {{ report.user.username }}
            </a>
          </td>
          <td>{{ report.team|capfirst }}</td>
          <td>{{ report.shift }}</td>
          <td>{{ report.custom_date|default:"â€”" }}</td>
          <td>{{ report.created_at|date:"Y-m-d H:i" }}</td>
          <td>
            {% if report.tasks %}
              {% for k, v in report.tasks.items %}
                <div>{{ k }}: <strong>{{ v }}</strong></div>
              {% endfor %}
            {% else %}
              â€”
            {% endif %}
          </td>
          <td>
            {% if report.notes %}
              {{ report.notes }}
            {% else %}
              â€”
            {% endif %}
          </td>
          <td>
            {% if report.is_late_submission %}
              <span class="text-danger">Late</span>
            {% else %}
              <span class="text-success">On Time</span>
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="8">No reports found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const ctx = document.getElementById('userComparisonChart').getContext('2d');
  const userComparisonChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [{% for row in reports_by_user %}'{{ row.user__username }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Total Reports',
        data: [{% for row in reports_by_user %}{{ row.total }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1,
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1 }
        }
      },
      plugins: {
        legend: { display: false },
        title: {
          display: true,
          text: 'Reports by User (Comparison)',
          font: { size: 16 }
        }
      }
    }
  });
</script>
{% endblock %}
