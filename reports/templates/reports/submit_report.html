{% extends "base.html" %}
{% load static %}

{% block title %}Submit Report{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- ================= Notices Box ================= -->
  {% if notices %}
  <div class="alert alert-info shadow-sm mb-4" role="alert" style="border-radius:12px;">
    <h5 class="fw-bold mb-2">üì¢ Important Notices</h5>
    <ul class="mb-0">
      {% for notice in notices %}
        <li><strong>{{ notice.title }}</strong> - <small>{{ notice.created_at|date:"d M Y" }}</small><br>{{ notice.content }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="row">
    <!-- ================= Submit Report Form ================= -->
    <div class="col-md-6">
      <div class="card p-4 shadow-sm" style="border-radius:16px;">
        <div class="text-center mb-3">
          <img src="{% static 'reports/Logo_border.png' %}" alt="Logo" height="60" class="mb-2">
          <h3 class="fw-bold text-primary mb-0">Daily Report</h3>
          <small class="text-muted">for <b>{{ request.user.username }}</b></small>
        </div>

        <form method="post" class="mt-3">
          {% csrf_token %}

          <div class="mb-3">
              <label class="form-label">Custom Date</label>
              {{ form.custom_date }}
          </div>

          <div class="mb-3">
              <label class="form-label">Shift Timing</label>
              {{ form.shift }}
          </div>

          <div class="mb-3">
              <label class="form-label">Notes</label>
              {{ form.notes }}
          </div>

          {% for field in form %}
              {% if field.name not in "custom_date shift notes" %}
                  <div class="mb-3">
                      <label class="form-label">{{ field.label }}</label>
                      {{ field }}
                  </div>
              {% endif %}
          {% endfor %}

          <button type="submit" class="btn btn-success w-100 py-2 fw-semibold">
              Submit Report
          </button>
        </form>
      </div>
    </div>

    <!-- ================= Calendar ================= -->
    <div class="col-md-6">
      <h5 class="mb-3">üóìÔ∏è Submission Calendar</h5>

      <div class="d-flex flex-wrap gap-3">
        <div id="prevCalendar" class="shadow-sm p-3 flex-fill" style="border-radius:12px; background:white; min-width: 300px;"></div>
        <div id="currCalendar" class="shadow-sm p-3 flex-fill" style="border-radius:12px; background:white; min-width: 300px;"></div>
      </div>

      <div class="mt-3">
        <span class="badge" style="background-color:#28a745;">Submitted</span>
        <span class="badge" style="background-color:#dc3545;">Not Submitted</span>
      </div>
    </div>

  </div>
</div>


<!-- ================= STYLES ================= -->
<style>
    body {
        background: #f4f6fb;
    }
    .card {
        background: white;
    }
    .form-label {
        font-weight: 500;
    }
    input, textarea, select {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 8px 10px;
    }
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
    }
    .btn-success {
        background: #009e60 !important;
        border: none;
        font-size: 16px;
    }
    .btn-success:hover {
        background: #007b4f !important;
    }
    .calendar-box {
      background: white;
      border-radius: 12px;
      min-height: 450px;
      overflow: hidden;
    }

    .fc {
      background: white;
      border-radius: 12px;
    }

    .fc .fc-daygrid-day-number {
      font-size: 14px;
    }

    .fc-daygrid-event {
      border-radius: 50% !important;
      width: 26px !important;
      height: 26px !important;
      display: flex !important;
      align-items: center;
      justify-content: center;
      margin: 3px auto !important;
      font-weight: bold;
      font-size: 14px;
      line-height: 1;
      padding: 0 !important;
    }

</style>

<!-- Calendar JS -->
<!-- ================= FullCalendar (Fixed Version) ================= -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const submissions = JSON.parse('{{ submission_dates|escapejs }}');
    console.log("‚úÖ submission_dates:", submissions);

    const submittedSet = new Set(submissions);
    const today = new Date();

    function createCalendar(elementId, offset) {
        const el = document.getElementById(elementId);
        if (!el) return console.error("Calendar div not found:", elementId);

        const monthDate = new Date(today.getFullYear(), today.getMonth() + offset, 1);
        const year = monthDate.getFullYear();
        const month = monthDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const events = [];
        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const dateStr = dateObj.toISOString().split("T")[0];

            if (submittedSet.has(dateStr)) {
                events.push({
                    title: "‚úî",
                    start: dateStr,
                    color: "#28a745",
                    textColor: "white"
                });
            } else if (dateObj <= today) {
                events.push({
                    title: "‚úñ",
                    start: dateStr,
                    color: "#dc3545",
                    textColor: "white"
                });
            }
        }

        console.log(`Rendering calendar: ${elementId} with ${events.length} events`);

        const calendar = new FullCalendar.Calendar(el, {
            initialView: "dayGridMonth",
            initialDate: monthDate,
            height: 450,
            headerToolbar: { left: "", center: "title", right: "" },
            events: events,
            eventDisplay: "block",
            fixedWeekCount: false
        });

        calendar.render();
    }

    createCalendar("prevCalendar", -1);
    createCalendar("currCalendar", 0);
});
</script>


{% endblock %}
