{% extends "base.html" %}
{% load static %}

{% block title %}Submit Report{% endblock %}

{% block content %}

<!-- ========= Notices ========= -->
{% if notices %}
<div class="alert alert-info shadow-sm mb-4" style="border-radius:12px;">
    <h5 class="fw-bold mb-2">üì¢ Important Notices</h5>
    <ul class="mb-0">
        {% for notice in notices %}
        <li>
            <strong>{{ notice.title }}</strong>
            - <small>{{ notice.created_at|date:"d M Y" }}</small><br>
            {{ notice.content }}
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row g-4">

    <!-- ========== LEFT: Report Form ========== -->
    <div class="col-lg-6">
        <div class="card p-4 shadow-sm" style="border-radius:16px;">

            <div class="text-center mb-3">
                <img src="{% static 'reports/Logo_border.png' %}" alt="Logo" height="70" class="mb-2">
                <h3 class="fw-bold text-primary mb-0">Daily Report</h3>
                <small class="text-muted">for <b>{{ request.user.username }}</b></small>
            </div>

            <form method="post" class="mt-3">
                {% csrf_token %}

                {% for field in form %}
                <div class="mb-3">
                    <label class="form-label">{{ field.label }}{% if field.field.required %} *{% endif %}</label>
                    {{ field }}
                    {% if field.help_text %}
                    <div class="form-text">{{ field.help_text }}</div>
                    {% endif %}
                    {% for error in field.errors %}
                    <div class="text-danger small">{{ error }}</div>
                    {% endfor %}
                </div>
                {% endfor %}

                {% if dynamic_fields %}
                <h5 class="mt-4 fw-bold text-primary border-top pt-3">Additional Fields</h5>

                {% for field in dynamic_fields %}
                <div class="mb-3">
                    <label class="form-label">{{ field.label }}{% if field.required %} *{% endif %}</label>

                    {% if field.field_type == "text" %}
                    <input type="text" name="{{ field.name }}" class="form-control" {% if field.required %}required{% endif %}>

                    {% elif field.field_type == "number" %}
                    <input type="number" name="{{ field.name }}" class="form-control" {% if field.required %}required{% endif %}>

                    {% elif field.field_type == "date" %}
                    <input type="date" name="{{ field.name }}" class="form-control" {% if field.required %}required{% endif %}>

                    {% elif field.field_type == "textarea" %}
                    <textarea name="{{ field.name }}" rows="3" class="form-control" {% if field.required %}required{% endif %}></textarea>

                    {% elif field.field_type == "boolean" %}
                    <div class="form-check">
                        <input type="checkbox" name="{{ field.name }}" class="form-check-input">
                        <label class="form-check-label">Yes / No</label>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% endif %}

                <button type="submit" class="btn btn-success w-100 py-2 fw-semibold mt-3">
                    Submit Report
                </button>
            </form>

        </div>
    </div>

    <!-- ========== RIGHT: Calendar ========== -->
    <div class="col-lg-6">
        <div class="card p-4 shadow-sm" style="border-radius:16px;">
            <h5 class="fw-bold mb-3">üóìÔ∏è Submission Calendar</h5>

            <div class="d-flex flex-wrap gap-3">
                <div id="prevCalendar" class="calendar-box"></div>
                <div id="currCalendar" class="calendar-box"></div>
            </div>

            <div class="mt-3">
                <span class="badge bg-success">Submitted</span>
                <span class="badge bg-danger">Not Submitted</span>
            </div>
        </div>
    </div>

</div>

<!-- ========= Styles ========= -->
<style>
    body { background: #f4f6fb !important; }

    .calendar-box {
        background: white;
        border-radius: 12px;
        padding: 12px;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        flex: 1;
        min-width: 300px;
    }

    input, textarea, select {
        border-radius: 8px !important;
        padding: 8px 10px !important;
        border: 1px solid #ccc !important;
    }

    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #007bff !important;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.2) !important;
    }

    .btn-success {
        background: #009e60 !important;
        border: none !important;
    }
    .btn-success:hover {
        background: #007b4f !important;
    }
</style>

<!-- ========= FullCalendar ========= -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const submissions = JSON.parse('{{ submission_dates|escapejs }}');
    const submittedSet = new Set(submissions);
    const today = new Date();

    // ‚≠ê Redirect to /my-report/<date>/
    function handleDateClick(info) {
        const date = info.dateStr;
        window.location.href = "/my-report/" + date + "/";
    }

    function createCalendar(elementId, offset) {
        const el = document.getElementById(elementId);
        if (!el) return;

        const monthDate = new Date(today.getFullYear(), today.getMonth() + offset, 1);
        const year = monthDate.getFullYear();
        const month = monthDate.getMonth();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        const events = [];

        for (let d = 1; d <= daysInMonth; d++) {
            const dateObj = new Date(year, month, d);
            const dateStr = dateObj.toISOString().split("T")[0];

            if (submittedSet.has(dateStr)) {
                events.push({ title: "‚úî", start: dateStr, color: "#28a745", textColor: "white" });
            } else if (dateObj <= today) {
                events.push({ title: "‚úñ", start: dateStr, color: "#dc3545", textColor: "white" });
            }
        }

        const calendar = new FullCalendar.Calendar(el, {
            initialView: "dayGridMonth",
            initialDate: monthDate,
            height: 430,
            headerToolbar: { left: "", center: "title", right: "" },
            events: events,
            eventDisplay: "block",
            fixedWeekCount: false,

            // ‚≠ê Add Date Click
            dateClick: handleDateClick
        });

        calendar.render();
    }

    createCalendar("prevCalendar", -1);
    createCalendar("currCalendar", 0);
});
</script>

{% endblock %}
