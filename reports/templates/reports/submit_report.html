{% extends "base.html" %}
{% load static %}

{% block title %}Submit Report{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- ================= Notices Box ================= -->
  {% if notices %}
  <div class="alert alert-info shadow-sm mb-4" role="alert" style="border-radius:12px;">
    <h5 class="fw-bold mb-2">üì¢ Important Notices</h5>
    <ul class="mb-0">
      {% for notice in notices %}
        <li><strong>{{ notice.title }}</strong> - <small>{{ notice.created_at|date:"d M Y" }}</small><br>{{ notice.content }}</li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="row">
    <!-- ================= Submit Report Form ================= -->
    <div class="col-md-6">
      <div class="card p-4 shadow-sm" style="border-radius:16px;">
        <div class="text-center mb-3">
          <img src="{% static 'reports/Logo_border.png' %}" alt="Logo" height="60" class="mb-2">
          <h3 class="fw-bold text-primary mb-0">Daily Report</h3>
          <small class="text-muted">for <b>{{ request.user.username }}</b></small>
        </div>

        <form method="post" class="mt-3">
          {% csrf_token %}

          <div class="mb-3">
              <label class="form-label">Custom Date</label>
              {{ form.custom_date }}
          </div>

          <div class="mb-3">
              <label class="form-label">Shift Timing</label>
              {{ form.shift }}
          </div>

          <div class="mb-3">
              <label class="form-label">Notes</label>
              {{ form.notes }}
          </div>

          {% for field in form %}
              {% if field.name not in "custom_date shift notes" %}
                  <div class="mb-3">
                      <label class="form-label">{{ field.label }}</label>
                      {{ field }}
                  </div>
              {% endif %}
          {% endfor %}

          <button type="submit" class="btn btn-success w-100 py-2 fw-semibold">
              Submit Report
          </button>
        </form>
      </div>
    </div>

    <!-- ================= Calendar ================= -->
    <div class="col-md-6">
      <h5 class="mb-3">üóìÔ∏è Submission Calendar</h5>
      <div id="calendar" class="shadow-sm p-3" style="border-radius:12px; background:white;"></div>
    </div>
  </div>
</div>
<p>DEBUG submission_dates: {{ submission_dates }}</p>

<!-- ================= STYLES ================= -->
<style>
    body {
        background: #f4f6fb;
    }
    .card {
        background: white;
    }
    .form-label {
        font-weight: 500;
    }
    input, textarea, select {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #ccc;
        padding: 8px 10px;
    }
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.2);
    }
    .btn-success {
        background: #009e60 !important;
        border: none;
        font-size: 16px;
    }
    .btn-success:hover {
        background: #007b4f !important;
    }
</style>

<!-- Calendar JS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');

    let submissions = [];
    try {
        submissions = JSON.parse('{{ submission_dates|escapejs }}');
    } catch(e) {
        console.error("Failed to parse submission_dates:", e);
    }

    console.log("Submissions for calendar inside DOMContentLoaded:", submissions);

    const events = submissions.map(date => ({
        title: 'Submitted',
        start: date,
        display: 'background',
        backgroundColor: '#28a74533',
        borderColor: '#28a745'
    }));

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        height: 500,
        selectable: false,
        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
        events: events
    });

    calendar.render();
});
</script>

{% endblock %}
