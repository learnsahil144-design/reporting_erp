{% extends "base.html" %}
{% load static %}

{% block title %}{{ user.username }} - Reports{% endblock %}

{% block content %}
<div class="container mt-3">
  <h2>ðŸ“Š {{ user.username|capfirst }}'s Report Overview</h2>

  <hr>

  <!-- Total Reports Table -->
  <h4>Total Reports</h4>
  <table class="table table-sm table-bordered">
    <thead>
      <tr>
        <th>Date</th>
        <th>Shift</th>
        <th>Tasks</th>
        <th>Notes</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
    {% for report in reports %}
        <tr>
        <td>{{ report.custom_date|default:"â€”" }}</td>
        <td>{{ report.shift }}</td>
        <td>
            {% if report.tasks %}
            {% for k, v in report.tasks.items %}
                <div>{{ k }}: <strong>{{ v }}</strong></div>
            {% endfor %}
            {% else %}
            â€”
            {% endif %}
        </td>
        <td>{{ report.notes|join:" | "|default:"â€”" }}</td>
        <td>
            {% if report.is_late_submission %}
            <span class="text-danger">Late</span>
            {% else %}
            <span class="text-success">On Time</span>
            {% endif %}
        </td>
        </tr>
    {% empty %}
        <tr><td colspan="5">No reports found.</td></tr>
    {% endfor %}
    </tbody>
  </table>

  <hr>

  <!-- Monthly Reports Chart -->
  <h4>Monthly Report Summary</h4>
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <canvas id="monthlyChart" height="120"></canvas>
    </div>
  </div>

  <!-- Yearly Reports Chart -->
  <h4>Yearly Report Summary</h4>
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <canvas id="yearlyChart" height="120"></canvas>
    </div>
  </div>

  <!-- Task Completion Chart -->
  <h4>Task Completion Overview</h4>
  <div class="card mb-3 shadow-sm">
    <div class="card-body">
      <canvas id="taskChart" height="120"></canvas>
    </div>
  </div>
</div>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ---------- Monthly Chart ----------
  const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
  new Chart(monthlyCtx, {
    type: 'bar',
    data: {
      labels: [{% for month in monthly_summary.keys %}'{{ month }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Reports per Month',
        data: [{% for count in monthly_summary.values %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(75, 192, 192, 0.5)',
        borderColor: 'rgba(75, 192, 192, 1)',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
      plugins: { legend: { display: false }, title: { display: true, text: 'Monthly Report Summary', font: { size: 16 } } }
    }
  });

  // ---------- Yearly Chart ----------
  const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
  new Chart(yearlyCtx, {
    type: 'bar',
    data: {
      labels: [{% for year in yearly_summary.keys %}'{{ year }}'{% if not forloop.last %}, {% endif %}{% endfor %}],
      datasets: [{
        label: 'Reports per Year',
        data: [{% for count in yearly_summary.values %}{{ count }}{% if not forloop.last %}, {% endif %}{% endfor %}],
        backgroundColor: 'rgba(255, 159, 64, 0.5)',
        borderColor: 'rgba(255, 159, 64, 1)',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
      plugins: { legend: { display: false }, title: { display: true, text: 'Yearly Report Summary', font: { size: 16 } } }
    }
  });

  // ---------- Task Completion Chart ----------
  const taskData = {{ task_totals|safe }};
  const taskLabels = Object.keys(taskData);
  const taskValues = Object.values(taskData);
  const taskCtx = document.getElementById('taskChart').getContext('2d');
  new Chart(taskCtx, {
    type: 'bar',
    data: {
      labels: taskLabels,
      datasets: [{
        label: 'Tasks Completed',
        data: taskValues,
        backgroundColor: 'rgba(54, 162, 235, 0.5)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } },
      plugins: { legend: { display: false }, title: { display: true, text: 'Task Completion Overview', font: { size: 16 } } }
    }
  });
</script>
{% endblock %}
