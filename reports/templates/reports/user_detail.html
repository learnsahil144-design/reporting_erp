{% extends "base.html" %}
{% load static %}

{% block title %}{{ user.username }} - Reports{% endblock %}

{% block content %}
<div class="container mt-3">
  <h2>ðŸ“Š {{ user.username|capfirst }}'s Report Overview</h2>
  <hr>

  <!-- Report Table -->
  <h4>All Reports</h4>
  <table class="table table-sm table-bordered" id="reportTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Shift</th>
        <th>Tasks</th>
        <th>Notes</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody>
      {% for report in reports %}
      <tr {% if forloop.counter > 10 %}class="extra-row d-none"{% endif %}>
        <td>{{ report.custom_date|default:"â€”" }}</td>
        <td>{{ report.shift }}</td>
        <td>
          {% if report.tasks %}
            {% for k, v in report.tasks.items %}
              <div>{{ k }}: <strong>{{ v }}</strong></div>
            {% endfor %}
          {% else %}â€”{% endif %}
        </td>
        <td>{{ report.notes|join:" | "|default:"â€”" }}</td>
        <td>
          {% if report.is_late_submission %}
            <span class="text-danger">Late</span>
          {% else %}
            <span class="text-success">On Time</span>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="5">No reports found.</td></tr>
      {% endfor %}
    </tbody>
  </table>

  {% if reports|length > 10 %}
  <div class="text-center mb-3">
    <button id="toggleBtn" class="btn btn-outline-primary btn-sm">Show More</button>
  </div>
  {% endif %}

  <hr>

  <!-- Charts -->
  <div class="row">
    <div class="col-md-12 mb-4">
      <h4>ðŸ“… Daily Task Comparison</h4>
      <div class="card shadow-sm">
        <div class="card-body">
          <canvas id="dailyChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <h4>ðŸ“ˆ Monthly Summary</h4>
      <div class="card shadow-sm">
        <div class="card-body">
          <canvas id="monthlyChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6 mb-4">
      <h4>ðŸ“† Yearly Summary</h4>
      <div class="card shadow-sm">
        <div class="card-body">
          <canvas id="yearlyChart" height="120"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-12 mb-4">
      <h4>ðŸ§© Task Totals</h4>
      <div class="card shadow-sm">
        <div class="card-body">
          <canvas id="taskChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ================= CHART.JS ================= -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // ---------- Show More / Show Less ----------
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('toggleBtn');
    if (!btn) return;

    let expanded = false;
    btn.addEventListener('click', () => {
      const rows = document.querySelectorAll('#reportTable .extra-row');
      rows.forEach(r => r.classList.toggle('d-none'));
      expanded = !expanded;
      btn.textContent = expanded ? 'Show Less' : 'Show More';
    });
  });

  // Parse safely â€” Django dicts â†’ JSON objects
  const dailyData = {{ daily_summary|safe }};
  const monthlyData = {{ monthly_summary|safe }};
  const yearlyData = {{ yearly_summary|safe }};
  const taskData = {{ task_totals|safe }};

  // ---------- DAILY CHART ----------
  if (Object.keys(dailyData).length > 0) {
    const ctxDaily = document.getElementById("dailyChart").getContext("2d");
    new Chart(ctxDaily, {
      type: "line",
      data: {
        labels: Object.keys(dailyData),
        datasets: [{
          label: "Total Tasks per Day",
          data: Object.values(dailyData),
          borderColor: "rgba(54, 162, 235, 1)",
          backgroundColor: "rgba(54, 162, 235, 0.3)",
          fill: true,
          tension: 0.3,
          pointRadius: 4
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // ---------- MONTHLY CHART ----------
  if (Object.keys(monthlyData).length > 0) {
    const ctxMonthly = document.getElementById("monthlyChart").getContext("2d");
    new Chart(ctxMonthly, {
      type: "bar",
      data: {
        labels: Object.keys(monthlyData),
        datasets: [{
          label: "Total Tasks per Month",
          data: Object.values(monthlyData),
          backgroundColor: "rgba(75, 192, 192, 0.5)",
          borderColor: "rgba(75, 192, 192, 1)",
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // ---------- YEARLY CHART ----------
  if (Object.keys(yearlyData).length > 0) {
    const ctxYearly = document.getElementById("yearlyChart").getContext("2d");
    new Chart(ctxYearly, {
      type: "bar",
      data: {
        labels: Object.keys(yearlyData),
        datasets: [{
          label: "Total Tasks per Year",
          data: Object.values(yearlyData),
          backgroundColor: "rgba(255, 159, 64, 0.5)",
          borderColor: "rgba(255, 159, 64, 1)",
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  }

  // ---------- TASK TOTALS CHART ----------
  if (Object.keys(taskData).length > 0) {
    const ctxTask = document.getElementById("taskChart").getContext("2d");
    new Chart(ctxTask, {
      type: "bar",
      data: {
        labels: Object.keys(taskData),
        datasets: [{
          label: "Total Tasks Completed",
          data: Object.values(taskData),
          backgroundColor: "rgba(153, 102, 255, 0.5)",
          borderColor: "rgba(153, 102, 255, 1)",
          borderWidth: 1,
          borderRadius: 4
        }]
      },
      options: {
        responsive: true,
        scales: { y: { beginAtZero: true } },
        plugins: { legend: { display: false } }
      }
    });
  }
</script>
{% endblock %}
